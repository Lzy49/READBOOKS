# 重新组织数据

## 拆分变量

### 动机

1. 如果变量承担了多个责任，它就应该被替换（拆分）为多个变量，每个变量只承担一个责任。同一个变量承担两件不同的事情，会令代码阅读者糊涂。

### 做法

1. 在待分解变量的声明及其第一次被赋值处，为其修改恰当名字
2. 如果可能将变量设置为不可修改值。
3. 以改变量的第二次赋值动作为界，修改此前所有变量的所有引用，让它们引用新的变量。
4. 测试。

## 字段改名

### 动机

命名很重要，对于程序中广泛使用的记录结构，其中字段的命名格外重要。数据结构对于帮助阅读者理解特别重要。所以有必要保持他们的整洁。

### 做法

1. 如果记录的作用域较小，可以直接修改所有该字段的代码，然后测试。结束
2. 如果记录还没有封装，则先封装记录。
3. 在封装内部对私有字段进行改名，并调整内部访问该字段的函数。
4. 测试。
5. 如果构造函数的参数用了旧的字段名，则为其改名。
6. 将获取值的函数改名，并修改所有调用者。

## 以查询取代派生变量

### 动机

1. 因为可变数据是软件中最大的错误源头，所以减少可变数据，可以减少 bug。
2. 以查询取代派生变量，可以减少可变数据。

### 注意

1. 不是所有派生变量都不对，当依赖变量不可变时，派生变量没有必要用查询代替（因为派生也不可变）
2. 派生变量用过即弃例如替代过长计算。则没有必要以查询代替。
3. 对于没有必要以查询代替派生的变量，使用查询替代，也是可以的。可以根据代码风格来进行调整

### 做法
1. 识别所有变量做更新的地方。如果有必要，用拆分变量分割各个更新点。
2. 新建一个函数，用于计算该变量的值。
3. 引入断言，断言该变量和计算函数始终产出同一个值。
4. 测试
5. 修改读取改变量的代码，以新建查询函数代替
6. 测试
7. 删除死代码。

## 将引用对象改为值对象
### 动机
把一个对象嵌入另一个对象。是有两种目的：
1. 为了使用对象的一些方法，或属性。且这些属性不会改变。（嵌入值对象）
2. 为了使用这个对象本身，且这个对象会被改变。（嵌入引用对象）
当我们使用引用对象，且只想使用一些方法和属性，且不想因为其他地方改变。而导致该对象发生改变。则我们应该嵌入值对象。
嵌入值对象和引用对象的区别在于：当需要该对象值发生变化时，是用心对象进行替代，还是在旧对象上做文章。所以：
我们想用值对象就要在改变它时将整个对象进行替换。
### 做法
1. 检查重构目标是否为不可变对象，或者是否可修改为不可变对象。
2. 用移除设值函数逐一去掉所有设值函数。（以声明新变量的形式替换修改变量）、
3. 提供一个基于值的相等判断函数，在其中使用值对象的字段。
## 将值对象改为引用对象
### 动机
1. 当对象被多次重复利用，应该进行保存。从而减少重复代码。
2. 当对象被多处使用，且有共同处理对象属性的需求。则应该使用引用对象。
### 做法
1. 为相关对象创建一个仓库（用来存放）
2. 确保构造函数有办法找到关联对象的正确实例
3. 修改宿主对象的构造函数，令其从仓库中取关联对象。每次修改进行测试。